
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Device Diagnostic — Pro (Client-only)</title>
  <meta name="description" content="Client-side device diagnostic dashboard — camera, mic, speed test, IP/ISP, battery, CPU, FPS, storage, QR, notepad, export (JSON/PDF), PWA-ready." />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = {theme: {extend: {colors: {brand:'#0b76ef'}}}}</script>
  <link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css">
  <style>
    /* small custom styles */
    .card { @apply bg-white rounded-xl shadow-md p-4; }
    .muted { color: #6b7280; }
    pre { background:#0b1320;color:#dbeafe;padding:12px;border-radius:8px;overflow:auto; white-space:pre-wrap; word-wrap:break-word; }
    video, canvas { border-radius:8px; }
    :root { --glass: rgba(255,255,255,0.6); }
    .glass { background:var(--glass); backdrop-filter: blur(6px); }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">
  <div class="max-w-6xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl font-semibold">Device Diagnostic — Pro (Client-side)</h1>
        <p class="muted text-sm">Local-only diagnostics. Nothing is uploaded unless you explicitly export or share.</p>
      </div>
      <div class="flex items-center gap-3">
        <button id="themeToggle" class="px-3 py-2 rounded-md bg-brand text-white text-sm">Dark</button>
        <button id="downloadReportBtn" class="px-3 py-2 rounded-md border text-sm">Export JSON</button>
      </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Left column: summary -->
      <section class="md:col-span-1">
        <div class="card mb-4">
          <h3 class="font-medium">Quick Summary</h3>
          <div class="mt-2 text-sm muted">Snapshot of your device</div>
          <div id="summaryCards" class="mt-3 grid grid-cols-2 gap-2"></div>
        </div>

        <div class="card mb-4">
          <h3 class="font-medium">Network</h3>
          <div class="mt-2 muted text-sm">IP, ISP, basic speed & ping</div>
          <div class="mt-3 space-y-2 text-sm">
            <div id="ipBox">IP: —</div>
            <div id="ispBox">ISP: —</div>
            <div id="speedBox">Speed: —</div>
            <div id="pingBox">Ping: —</div>
            <div class="flex gap-2 mt-2">
              <button id="btnIp" class="px-2 py-1 rounded bg-brand text-white text-sm">Get IP</button>
              <button id="btnSpeed" class="px-2 py-1 rounded border text-sm">Speed test</button>
              <button id="btnPing" class="px-2 py-1 rounded border text-sm">Ping</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 class="font-medium">Privacy</h3>
          <div class="mt-2 muted text-sm">This tool is client-only. It will never send data to a server unless you export and choose to share it.</div>
          <div class="mt-3 text-xs">
            <label class="flex items-center gap-2"><input type="checkbox" id="optLabels"> Show device labels (requires permission)</label>
          </div>
        </div>
      </section>

      <!-- Middle column: dashboard cards -->
      <section class="md:col-span-2">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <!-- Browser & Device -->
          <div class="card">
            <div class="flex items-center justify-between">
              <h3 class="font-medium">Browser & Device</h3>
              <div class="muted text-sm">non-permissioned info</div>
            </div>
            <pre id="basicInfo" class="mt-3">Loading...</pre>
            <div class="mt-2 flex gap-2">
              <button id="refreshBasic" class="px-3 py-1 rounded border text-sm">Refresh</button>
              <button id="btnBattery" class="px-3 py-1 rounded border text-sm">Get Battery</button>
            </div>
          </div>

          <!-- Performance -->
          <div class="card">
            <h3 class="font-medium">Performance Tests</h3>
            <div class="muted text-sm mt-1">Run quick CPU / FPS tests</div>
            <div class="mt-3 flex flex-col gap-2">
              <div class="flex gap-2">
                <button id="btnCpu" class="px-3 py-1 rounded border text-sm">CPU stress</button>
                <button id="btnFps" class="px-3 py-1 rounded border text-sm">FPS Test</button>
                <button id="btnStorage" class="px-3 py-1 rounded border text-sm">LocalStorage test</button>
              </div>
              <div id="perfResult" class="text-sm muted"></div>
            </div>
          </div>

          <!-- Camera & Mic -->
          <div class="card">
            <h3 class="font-medium">Camera & Microphone</h3>
            <div class="muted text-sm mt-1">Allow camera/mic to test preview, snapshot & recording</div>
            <div class="mt-3 grid grid-cols-1 gap-2">
              <div>
                <label class="text-sm">Camera</label>
                <div class="flex gap-2 mt-1">
                  <select id="videoDevices" class="flex-1 rounded border p-1"></select>
                  <button id="startCamera" class="px-2 py-1 rounded border text-sm">Start</button>
                  <button id="snap" class="px-2 py-1 rounded border text-sm">Snapshot</button>
                </div>
                <video id="preview" autoplay playsinline muted class="w-full mt-2 h-48 bg-black"></video>
              </div>

              <div>
                <label class="text-sm">Microphone</label>
                <div class="flex gap-2 mt-1">
                  <select id="audioDevices" class="flex-1 rounded border p-1"></select>
                  <button id="startMic" class="px-2 py-1 rounded border text-sm">Test</button>
                </div>
                <div class="mt-2 flex gap-2">
                  <button id="startRec" class="px-3 py-1 rounded bg-brand text-white text-sm">Start Rec</button>
                  <button id="stopRec" class="px-3 py-1 rounded border text-sm" disabled>Stop</button>
                </div>
                <div id="recordings" class="mt-2 text-sm muted"></div>
              </div>

            </div>
          </div>

          <!-- Tools: QR, Clipboard, Notepad -->
          <div class="card">
            <h3 class="font-medium">Tools</h3>
            <div class="mt-2 grid grid-cols-1 gap-2">
              <div>
                <label class="text-sm">Simple Notepad</label>
                <textarea id="notepad" class="w-full mt-1 border rounded p-2" rows="3" placeholder="Take notes... (local only)"></textarea>
                <div class="mt-2 flex gap-2">
                  <button id="saveNote" class="px-3 py-1 rounded border text-sm">Save</button>
                  <button id="clearNote" class="px-3 py-1 rounded border text-sm">Clear</button>
                </div>
              </div>

              <div>
                <label class="text-sm">QR Code (from text)</label>
                <input id="qrText" class="w-full mt-1 border rounded p-1" placeholder="Enter text to generate QR" />
                <div class="mt-2 flex gap-2 items-center">
                  <button id="genQr" class="px-3 py-1 rounded border text-sm">Generate</button>
                  <div id="qrcode" class="ml-2"></div>
                </div>
              </div>

              <div>
                <label class="text-sm">Clipboard</label>
                <div class="mt-1 flex gap-2">
                  <input id="clipIn" class="flex-1 border rounded p-1" placeholder="Text to copy" />
                  <button id="copyBtn" class="px-3 py-1 rounded border text-sm">Copy</button>
                </div>
              </div>

            </div>
          </div>

        </div>

        <!-- Device list & advanced -->
        <div class="card mt-4">
          <h3 class="font-medium">Devices & Export</h3>
          <div class="muted text-sm mt-1">Enumerate devices and export a JSON/PDF report</div>
          <div class="mt-3 flex gap-2">
            <button id="listDevices" class="px-3 py-1 rounded border text-sm">List Devices</button>
            <button id="downloadJson" class="px-3 py-1 rounded border text-sm">Download JSON</button>
            <button id="downloadPdf" class="px-3 py-1 rounded border text-sm">Download PDF</button>
          </div>
          <pre id="devicesList" class="mt-3">-</pre>
        </div>

      </section>
    </main>

    <footer class="mt-6 text-center muted text-sm">Only use this on your own devices or with consent. This app is client-only — no server uploads by default.</footer>
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // State
    const state = { basic: {}, ip: null, speed: null, ping: null, devices: [], recordings: [] };

    // Basic info
    function showBasic(){
      const nav = navigator;
      const info = {
        userAgent: nav.userAgent,
        platform: nav.platform,
        language: nav.language,
        cookiesEnabled: nav.cookieEnabled,
        online: nav.onLine,
        hardwareConcurrency: nav.hardwareConcurrency || 'n/a',
        deviceMemory: nav.deviceMemory || 'n/a',
        vendor: nav.vendor || 'n/a',
        webdriver: !!nav.webdriver,
        screen: { width: screen.width, height: screen.height, pixelRatio: window.devicePixelRatio }
      };
      state.basic = info;
      document.getElementById('basicInfo').textContent = JSON.stringify(info,null,2);
      updateSummaryCards();
    }
    document.getElementById('refreshBasic').addEventListener('click', showBasic);
    showBasic();

    function updateSummaryCards(){
      const box = document.getElementById('summaryCards'); box.innerHTML='';
      const items = [
        ['Browser', navigator.userAgent],
        ['Platform', navigator.platform],
        ['Resolution', screen.width+'x'+screen.height],
        ['Cores', navigator.hardwareConcurrency || 'n/a']
      ];
      items.forEach(it=>{
        const el = document.createElement('div'); el.className='p-3 bg-white rounded-lg shadow flex flex-col';
        el.innerHTML = `<div class="text-xs muted">${it[0]}</div><div class="font-medium text-sm mt-1">${it[1]}</div>`;
        box.appendChild(el);
      });
    }

    // IP & ISP
    document.getElementById('btnIp').addEventListener('click', async ()=>{
      const ipBox = document.getElementById('ipBox'); ipBox.textContent='Fetching...';
      try{
        const r = await fetch('https://ipapi.co/json/'); if(!r.ok) throw 0; const j = await r.json();
        state.ip = j; document.getElementById('ipBox').textContent = 'IP: '+j.ip; document.getElementById('ispBox').textContent = 'ISP: '+(j.org||j.company||'-');
      }catch(e){ ipBox.textContent='IP lookup failed (CORS/offline)'; }
    });

    // Improved Speed test using progressive downloads (best-effort client-side)
    async function runSpeedTest(){
      const box = document.getElementById('speedBox'); box.textContent='Running...';
      // We'll attempt multiple hosts to improve chance of CORS success.
      const testFiles = [
        'https://speed.hetzner.de/100KB.bin',
        'https://download.samplelib.com/mp4/sample-5s.mp4',
        'https://ipv4.download.thinkbroadband.com/5MB.zip'
      ];
      let results = [];
      for(const url of testFiles){
        try{
          const start = performance.now();
          const r = await fetch(url, {cache:'no-store'});
          const blob = await r.blob();
          const ms = performance.now() - start;
          const bitsPerSec = (blob.size * 8) / (ms/1000);
          const mbps = bitsPerSec / (1024*1024);
          results.push({url, mbps, bytes: blob.size, ms});
        }catch(e){
          // ignore failures; continue
        }
      }
      if(results.length === 0){ box.textContent = 'Speed test failed (CORS or blocked). Try from a hosted HTTPS site.'; return; }
      // take average of results
      const avg = results.reduce((s,r)=>s + r.mbps, 0) / results.length;
      state.speed = {avgMbps: avg.toFixed(2), details: results};
      box.textContent = `${avg.toFixed(2)} Mbps (approx, ${results.length} hosts)`;
    }
    document.getElementById('btnSpeed').addEventListener('click', runSpeedTest);

    // Ping (approx) - use fetch to public domain and measure latency; CORS may block so it's best-effort
    document.getElementById('btnPing').addEventListener('click', async ()=>{
      const box = document.getElementById('pingBox'); box.textContent='Pinging...';
      const hosts = ['https://example.com', 'https://cloudflare.com', 'https://google.com'];
      let times=[];
      for(const h of hosts){
        try{
          const start = performance.now();
          await fetch(h, {method:'HEAD', mode:'no-cors', cache:'no-store'});
          const ms = performance.now() - start;
          times.push(ms);
        }catch(e){
          // push nothing on fail
        }
      }
      if(times.length===0){ box.textContent = 'Ping test: may be blocked by CORS.'; return; }
      const avg = times.reduce((s,t)=>s+t,0)/times.length;
      state.ping = avg;
      box.textContent = `${avg.toFixed(0)} ms (approx)`;
    });

    // Battery
    document.getElementById('btnBattery').addEventListener('click', async ()=>{
      try{
        const bat = await navigator.getBattery();
        alert('Battery: '+(bat.level*100).toFixed(0)+'% — charging: '+bat.charging);
      }catch(e){ alert('Battery API not supported'); }
    });

    // Enumerate devices
    async function enumerateMedia(){
      try{
        const devices = await navigator.mediaDevices.enumerateDevices(); state.devices = devices;
        const v = document.getElementById('videoDevices'); const a = document.getElementById('audioDevices'); v.innerHTML=''; a.innerHTML='';
        devices.forEach(d=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||d.kind+' '+(d.deviceId||'n/a').slice(0,6); if(d.kind==='videoinput') v.appendChild(o); if(d.kind==='audioinput') a.appendChild(o); });
        document.getElementById('devicesList').textContent = JSON.stringify(devices.map(x=>({kind:x.kind,label:x.label})),null,2);
      }catch(e){ document.getElementById('devicesList').textContent='enumerateDevices failed — allow permissions or use https.'; }
    }
    document.getElementById('listDevices').addEventListener('click', enumerateMedia);
    if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) enumerateMedia();

    // Camera preview & snapshot
    let currentStream=null; document.getElementById('startCamera').addEventListener('click', async ()=>{
      const sel = document.getElementById('videoDevices'); const id = sel.value||undefined; try{ if(currentStream) currentStream.getTracks().forEach(t=>t.stop()); const s = await navigator.mediaDevices.getUserMedia({video: id?{deviceId:{exact:id}}:true}); currentStream=s; document.getElementById('preview').srcObject=s; await enumerateMedia(); }catch(e){ alert('Camera failed: '+(e.message||e)); }
    });
    document.getElementById('snap').addEventListener('click', ()=>{
      const vid = document.getElementById('preview'); if(!vid.srcObject) return alert('Start camera first'); const c=document.createElement('canvas'); c.width=vid.videoWidth||640; c.height=vid.videoHeight||480; c.getContext('2d').drawImage(vid,0,0,c.width,c.height); c.toBlob(b=>{ const url = URL.createObjectURL(b); const a=document.createElement('a'); a.href=url; a.download='snapshot.png'; a.click(); },'image/png');
    });

    // Mic test and recording
    let mediaRecorder=null, recordedChunks=[];
    document.getElementById('startMic').addEventListener('click', async ()=>{
      const sel = document.getElementById('audioDevices'); const id = sel.value||undefined; try{ const s = await navigator.mediaDevices.getUserMedia({audio: id?{deviceId:{exact:id}}:true}); const ctx = new AudioContext(); const src = ctx.createMediaStreamSource(s); // create analyser for visualizer
        const analyser = ctx.createAnalyser(); src.connect(analyser); analyser.connect(ctx.destination);
        setTimeout(()=>s.getTracks().forEach(t=>t.stop()),800); alert('Mic permission granted (short test)'); await enumerateMedia(); }catch(e){ alert('Mic failed: '+(e.message||e)); }
    });

    document.getElementById('startRec').addEventListener('click', async ()=>{
      const vsel = document.getElementById('videoDevices').value; const asel = document.getElementById('audioDevices').value;
      try{
        const stream = await navigator.mediaDevices.getUserMedia({video: vsel?{deviceId:{exact:vsel}}:true, audio: asel?{deviceId:{exact:asel}}:true});
        document.getElementById('preview').srcObject = stream; recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size) recordedChunks.push(e.data); };
        mediaRecorder.onstop = ()=>{
          const blob = new Blob(recordedChunks, { type: 'video/webm' }); const url = URL.createObjectURL(blob);
          const list = document.getElementById('recordings'); const a = document.createElement('a'); a.href = url; a.download='recording.webm'; a.textContent = 'Download recording ('+(blob.size/1024).toFixed(0)+' KB)'; list.prepend(a);
          stream.getTracks().forEach(t=>t.stop()); state.recordings.push({size:blob.size});
        };
        mediaRecorder.start(); document.getElementById('startRec').disabled=true; document.getElementById('stopRec').disabled=false;
      }catch(e){ alert('Recording failed: '+(e.message||e)); }
    });
    document.getElementById('stopRec').addEventListener('click', ()=>{ if(mediaRecorder && mediaRecorder.state!=='inactive') mediaRecorder.stop(); document.getElementById('startRec').disabled=false; document.getElementById('stopRec').disabled=true; });

    // Notepad
    document.getElementById('saveNote').addEventListener('click', ()=>{ localStorage.setItem('diag_notepad', document.getElementById('notepad').value); alert('Saved locally'); });
    document.getElementById('clearNote').addEventListener('click', ()=>{ document.getElementById('notepad').value=''; localStorage.removeItem('diag_notepad'); });
    document.getElementById('notepad').value = localStorage.getItem('diag_notepad')||'';

    // QR generator
    document.getElementById('genQr').addEventListener('click', ()=>{
      const t = document.getElementById('qrText').value||' '; document.getElementById('qrcode').innerHTML=''; new QRCode(document.getElementById('qrcode'), { text: t, width: 128, height: 128 });
    });

    // Clipboard
    document.getElementById('copyBtn').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(document.getElementById('clipIn').value); alert('Copied'); }catch(e){ alert('Copy failed'); } });

    // Performance tests
    document.getElementById('btnCpu').addEventListener('click', ()=>{
      const t0 = performance.now(); let x=0; for(let i=0;i<5e7;i++){ x += i%3; } const ms = performance.now()-t0; document.getElementById('perfResult').textContent = 'CPU test completed: '+ms.toFixed(0)+' ms';
    });
    document.getElementById('btnFps').addEventListener('click', ()=>{
      let frames=0, running=true; const start = performance.now(); function f(){ if(!running) return; frames++; if(performance.now()-start<3000){ requestAnimationFrame(f);} else { const fps = (frames/3).toFixed(0); document.getElementById('perfResult').textContent='FPS approx: '+fps; running=false; } } f();
    });
    document.getElementById('btnStorage').addEventListener('click', ()=>{
      try{ const key='diag_test'; let s='x'.repeat(1024*50); localStorage.setItem(key,s); localStorage.removeItem(key); document.getElementById('perfResult').textContent='LocalStorage test OK (50 KB)'; }catch(e){ document.getElementById('perfResult').textContent='LocalStorage test failed'; }
    });

    // Export JSON & PDF
    function buildReport(){
      return {
        generatedAt: new Date().toISOString(), basic: state.basic, ip: state.ip, speed: state.speed, ping: state.ping, devices: state.devices.map(d=>({kind:d.kind,label:d.label})), recordings: state.recordings
      };
    }
    document.getElementById('downloadJson').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(buildReport(),null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='device-report.json'; a.click();
    });
    document.getElementById('downloadReportBtn').addEventListener('click', ()=>{ document.getElementById('downloadJson').click(); });

    document.getElementById('downloadPdf').addEventListener('click', async ()=>{
      const { jsPDF } = window.jspdf; const doc = new jsPDF(); const r = buildReport(); doc.setFontSize(12); doc.text('Device Diagnostic Report',14,14); doc.setFontSize(9);
      const lines = JSON.stringify(r,null,2).match(/.{1,800}/g) || []; let y=24; lines.forEach(l=>{ doc.text(l,14,y); y+=6; if(y>270){ doc.addPage(); y=14; } }); doc.save('device-report.pdf');
    });

    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', ()=>{
      document.documentElement.classList.toggle('dark'); if(document.documentElement.classList.contains('dark')){ document.body.classList.add('bg-slate-900','text-white'); document.getElementById('themeToggle').textContent='Light'; } else { document.body.classList.remove('bg-slate-900','text-white'); document.getElementById('themeToggle').textContent='Dark'; }
    });

    // Download top-level JSON (no-op placeholder already wired)
    document.getElementById('downloadJson').addEventListener('click', ()=>{});

    // Initial populate
    updateSummaryCards();
  </script>
</body>
</html>
